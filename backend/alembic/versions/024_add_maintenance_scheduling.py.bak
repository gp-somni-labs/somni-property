"""Add maintenance scheduling system

Revision ID: 024_add_maintenance_scheduling
Revises: 023_merge_heads
Create Date: 2025-11-20 20:00:00.000000

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects.postgresql import UUID, ARRAY, JSONB

# revision identifiers, used by Alembic.
revision = '024_add_maintenance_scheduling'
down_revision = '023_merge_heads'
branch_labels = None
depends_on = None


def upgrade():
    """
    Add maintenance scheduling tables:
    - maintenance_schedules: Recurring maintenance definitions
    - maintenance_tasks: Individual maintenance instances
    """

    # ========================================================================
    # CREATE MAINTENANCE_SCHEDULES TABLE
    # ========================================================================
    op.create_table(
        'maintenance_schedules',
        sa.Column('id', UUID(as_uuid=True), primary_key=True),

        # Foreign Keys
        sa.Column('property_id', UUID(as_uuid=True), sa.ForeignKey('properties.id', ondelete='CASCADE'), nullable=True),
        sa.Column('building_id', UUID(as_uuid=True), sa.ForeignKey('buildings.id', ondelete='CASCADE'), nullable=True),
        sa.Column('unit_id', UUID(as_uuid=True), sa.ForeignKey('units.id', ondelete='CASCADE'), nullable=True),
        sa.Column('contractor_id', UUID(as_uuid=True), sa.ForeignKey('contractors.id', ondelete='SET NULL'), nullable=True),

        # Schedule Details
        sa.Column('title', sa.String(255), nullable=False),
        sa.Column('description', sa.Text, nullable=True),
        sa.Column('category', sa.String(50), nullable=False),
        sa.Column('priority', sa.String(20), nullable=False, server_default='medium'),

        # Frequency Configuration
        sa.Column('frequency', sa.String(20), nullable=False),
        sa.Column('interval_days', sa.Integer, nullable=True),

        # Scheduling
        sa.Column('start_date', sa.DateTime(timezone=True), nullable=False),
        sa.Column('end_date', sa.DateTime(timezone=True), nullable=True),
        sa.Column('next_due_date', sa.DateTime(timezone=True), nullable=True),
        sa.Column('last_completed_date', sa.DateTime(timezone=True), nullable=True),

        # Task Configuration
        sa.Column('estimated_duration_hours', sa.DECIMAL(5, 2), nullable=True),
        sa.Column('estimated_cost', sa.DECIMAL(10, 2), nullable=True),

        # Instructions
        sa.Column('instructions', sa.Text, nullable=True),
        sa.Column('checklist', JSONB, nullable=True),
        sa.Column('required_tools', ARRAY(sa.String), nullable=True),
        sa.Column('required_materials', ARRAY(sa.String), nullable=True),

        # Auto-creation settings
        sa.Column('auto_create_workorder', sa.Boolean, server_default='true'),
        sa.Column('auto_assign_contractor', sa.Boolean, server_default='false'),
        sa.Column('advance_notice_days', sa.Integer, server_default='7'),

        # Status
        sa.Column('status', sa.String(20), nullable=False, server_default='active'),
        sa.Column('is_active', sa.Boolean, server_default='true'),

        # Metadata
        sa.Column('notes', sa.Text, nullable=True),
        sa.Column('attachments', JSONB, nullable=True),
        sa.Column('tags', ARRAY(sa.String), nullable=True),

        # Audit fields
        sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.Column('created_by', sa.String(255), nullable=True),
    )

    # Indexes for maintenance_schedules
    op.create_index('idx_maintenance_schedules_property_id', 'maintenance_schedules', ['property_id'])
    op.create_index('idx_maintenance_schedules_building_id', 'maintenance_schedules', ['building_id'])
    op.create_index('idx_maintenance_schedules_unit_id', 'maintenance_schedules', ['unit_id'])
    op.create_index('idx_maintenance_schedules_contractor_id', 'maintenance_schedules', ['contractor_id'])
    op.create_index('idx_maintenance_schedules_title', 'maintenance_schedules', ['title'])
    op.create_index('idx_maintenance_schedules_next_due_date', 'maintenance_schedules', ['next_due_date'])
    op.create_index('idx_maintenance_schedules_is_active', 'maintenance_schedules', ['is_active'])

    # ========================================================================
    # CREATE MAINTENANCE_TASKS TABLE
    # ========================================================================
    op.create_table(
        'maintenance_tasks',
        sa.Column('id', UUID(as_uuid=True), primary_key=True),

        # Foreign Keys
        sa.Column('schedule_id', UUID(as_uuid=True), sa.ForeignKey('maintenance_schedules.id', ondelete='SET NULL'), nullable=True),
        sa.Column('property_id', UUID(as_uuid=True), sa.ForeignKey('properties.id', ondelete='CASCADE'), nullable=True),
        sa.Column('building_id', UUID(as_uuid=True), sa.ForeignKey('buildings.id', ondelete='CASCADE'), nullable=True),
        sa.Column('unit_id', UUID(as_uuid=True), sa.ForeignKey('units.id', ondelete='CASCADE'), nullable=True),
        sa.Column('contractor_id', UUID(as_uuid=True), sa.ForeignKey('contractors.id', ondelete='SET NULL'), nullable=True),
        sa.Column('work_order_id', UUID(as_uuid=True), sa.ForeignKey('work_orders.id', ondelete='SET NULL'), nullable=True),

        # Task Details
        sa.Column('title', sa.String(255), nullable=False),
        sa.Column('description', sa.Text, nullable=True),
        sa.Column('category', sa.String(50), nullable=False),
        sa.Column('priority', sa.String(20), nullable=False, server_default='medium'),

        # Scheduling
        sa.Column('scheduled_date', sa.DateTime(timezone=True), nullable=False),
        sa.Column('due_date', sa.DateTime(timezone=True), nullable=True),
        sa.Column('started_at', sa.DateTime(timezone=True), nullable=True),
        sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),

        # Execution Details
        sa.Column('estimated_duration_hours', sa.DECIMAL(5, 2), nullable=True),
        sa.Column('actual_duration_hours', sa.DECIMAL(5, 2), nullable=True),
        sa.Column('estimated_cost', sa.DECIMAL(10, 2), nullable=True),
        sa.Column('actual_cost', sa.DECIMAL(10, 2), nullable=True),

        # Instructions & Completion
        sa.Column('instructions', sa.Text, nullable=True),
        sa.Column('checklist', JSONB, nullable=True),
        sa.Column('completion_notes', sa.Text, nullable=True),
        sa.Column('completion_photos', JSONB, nullable=True),

        # Status
        sa.Column('status', sa.String(20), nullable=False, server_default='scheduled'),
        sa.Column('is_overdue', sa.Boolean, server_default='false'),

        # Metadata
        sa.Column('assigned_to', sa.String(255), nullable=True),
        sa.Column('completed_by', sa.String(255), nullable=True),
        sa.Column('notes', sa.Text, nullable=True),
        sa.Column('tags', ARRAY(sa.String), nullable=True),

        # Audit fields
        sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
        sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False, server_default=sa.func.now()),
    )

    # Indexes for maintenance_tasks
    op.create_index('idx_maintenance_tasks_schedule_id', 'maintenance_tasks', ['schedule_id'])
    op.create_index('idx_maintenance_tasks_property_id', 'maintenance_tasks', ['property_id'])
    op.create_index('idx_maintenance_tasks_building_id', 'maintenance_tasks', ['building_id'])
    op.create_index('idx_maintenance_tasks_unit_id', 'maintenance_tasks', ['unit_id'])
    op.create_index('idx_maintenance_tasks_contractor_id', 'maintenance_tasks', ['contractor_id'])
    op.create_index('idx_maintenance_tasks_work_order_id', 'maintenance_tasks', ['work_order_id'])
    op.create_index('idx_maintenance_tasks_title', 'maintenance_tasks', ['title'])
    op.create_index('idx_maintenance_tasks_scheduled_date', 'maintenance_tasks', ['scheduled_date'])
    op.create_index('idx_maintenance_tasks_status', 'maintenance_tasks', ['status'])
    op.create_index('idx_maintenance_tasks_is_overdue', 'maintenance_tasks', ['is_overdue'])

    print("‚úÖ Created maintenance_schedules and maintenance_tasks tables")


def downgrade():
    """Remove maintenance scheduling tables"""
    op.drop_index('idx_maintenance_tasks_is_overdue', 'maintenance_tasks')
    op.drop_index('idx_maintenance_tasks_status', 'maintenance_tasks')
    op.drop_index('idx_maintenance_tasks_scheduled_date', 'maintenance_tasks')
    op.drop_index('idx_maintenance_tasks_title', 'maintenance_tasks')
    op.drop_index('idx_maintenance_tasks_work_order_id', 'maintenance_tasks')
    op.drop_index('idx_maintenance_tasks_contractor_id', 'maintenance_tasks')
    op.drop_index('idx_maintenance_tasks_unit_id', 'maintenance_tasks')
    op.drop_index('idx_maintenance_tasks_building_id', 'maintenance_tasks')
    op.drop_index('idx_maintenance_tasks_property_id', 'maintenance_tasks')
    op.drop_index('idx_maintenance_tasks_schedule_id', 'maintenance_tasks')
    op.drop_table('maintenance_tasks')

    op.drop_index('idx_maintenance_schedules_is_active', 'maintenance_schedules')
    op.drop_index('idx_maintenance_schedules_next_due_date', 'maintenance_schedules')
    op.drop_index('idx_maintenance_schedules_title', 'maintenance_schedules')
    op.drop_index('idx_maintenance_schedules_contractor_id', 'maintenance_schedules')
    op.drop_index('idx_maintenance_schedules_unit_id', 'maintenance_schedules')
    op.drop_index('idx_maintenance_schedules_building_id', 'maintenance_schedules')
    op.drop_index('idx_maintenance_schedules_property_id', 'maintenance_schedules')
    op.drop_table('maintenance_schedules')

    print("üóëÔ∏è  Removed maintenance_schedules and maintenance_tasks tables")
